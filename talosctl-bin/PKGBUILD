pkgname=talosctl-bin
pkgver='1.11.6'
pkgrel=1
pkgdesc="talosctl - utility for controlling Talos"
arch=('x86_64' 'aarch64' 'armv7h')
url="https://talos.dev/"
license=('MPL-2.0')

# Arch-per-arch sources (prebuilt upstream binaries)
source_x86_64=(
  "talosctl-linux-amd64-v${pkgver}::https://github.com/siderolabs/talos/releases/download/v${pkgver}/talosctl-linux-amd64"
)
source_aarch64=(
  "talosctl-linux-arm64-v${pkgver}::https://github.com/siderolabs/talos/releases/download/v${pkgver}/talosctl-linux-arm64"
)
source_armv7h=(
  "talosctl-linux-armv7-v${pkgver}::https://github.com/siderolabs/talos/releases/download/v${pkgver}/talosctl-linux-armv7"
)

sha256sums_x86_64=('a248ef5c5f9cab08013281e6e14d8d8862e7363515e58e2fba8c94ca05c5cf34')
sha256sums_aarch64=('39c4e3d1bda2870a2de5a4f30a6f728914d3d27da5bf75380387717d75ed694a')
sha256sums_armv7h=('ae88b9c32a724892b9ed58b46f44b606e951a4cf90acd170dffcd8020a76a79a')

# Don't strip the prebuilt binary
options=(!strip)

# Optional: no build() because this is a binary package

check() {
  local bin_src
  case "$CARCH" in
    x86_64) bin_src="${srcdir}/talosctl-linux-amd64-v${pkgver}" ;;
    aarch64) bin_src="${srcdir}/talosctl-linux-arm64-v${pkgver}" ;;
    armv7h) bin_src="${srcdir}/talosctl-linux-armv7-v${pkgver}" ;;
    *) echo "Unsupported architecture: $CARCH" >&2; return 1 ;;
  esac

  # Ensure the binary is executable (in case upstream ships it 0644)
  chmod +x "${bin_src}"

  # Sanity check: binary runs and prints help, no endpoints required
  "${bin_src}" --help >/dev/null
}

package() {
  local bin_src
  case "$CARCH" in
    x86_64) bin_src="${srcdir}/talosctl-linux-amd64-v${pkgver}" ;;
    aarch64) bin_src="${srcdir}/talosctl-linux-arm64-v${pkgver}" ;;
    armv7h) bin_src="${srcdir}/talosctl-linux-armv7-v${pkgver}" ;;
    *) echo "Unsupported architecture: $CARCH" >&2; return 1 ;;
  esac

  install -Dm755 "${bin_src}" "${pkgdir}/usr/bin/talosctl"

  # Shell completions
  "${pkgdir}/usr/bin/talosctl" completion bash | install -Dm644 /dev/stdin \
    "${pkgdir}/usr/share/bash-completion/completions/talosctl"
  "${pkgdir}/usr/bin/talosctl" completion zsh | install -Dm644 /dev/stdin \
    "${pkgdir}/usr/share/zsh/site-functions/_talosctl"
  "${pkgdir}/usr/bin/talosctl" completion fish | install -Dm644 /dev/stdin \
    "${pkgdir}/usr/share/fish/vendor_completions.d/talosctl.fish"
}
