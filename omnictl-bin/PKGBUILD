pkgname=omnictl-bin
pkgver=1.3.3
pkgrel=1
pkgdesc="CLI for Omni - SaaS-simple deployment of Kubernetes on your own hardware"
arch=('x86_64' 'aarch64')
url="https://omni.siderolabs.com/"
license=('BUSL-1.1')

# Prebuilt upstream binaries per-arch :contentReference[oaicite:0]{index=0}
source_x86_64=(
  "omnictl-linux-amd64-v${pkgver}::https://github.com/siderolabs/omni/releases/download/v${pkgver}/omnictl-linux-amd64"
)
source_aarch64=(
  "omnictl-linux-arm64-v${pkgver}::https://github.com/siderolabs/omni/releases/download/v${pkgver}/omnictl-linux-arm64"
)

# Checksums from upstream/Homebrew formula :contentReference[oaicite:1]{index=1}
sha256sums_x86_64=('c178419669e5cf5a69b92e931de7c19d05d83d816f1dc70971dc3db141e6eef5')
sha256sums_aarch64=('798252cd330b8fcef9d4c2b6687c371e311f13d71804810f52056d180dbc6aa9')

# Don't strip the prebuilt binary
options=(!strip)

# No build() because this is a binary package

check() {
  local bin_src
  case "$CARCH" in
    x86_64)  bin_src="${srcdir}/omnictl-linux-amd64-v${pkgver}" ;;
    aarch64) bin_src="${srcdir}/omnictl-linux-arm64-v${pkgver}" ;;
    *) echo "Unsupported architecture: $CARCH" >&2; return 1 ;;
  esac

  # Ensure the downloaded binary is executable
  chmod +x "${bin_src}"

  # Lightweight sanity check: binary runs and prints help
  "${bin_src}" --help >/dev/null
}

package() {
  local bin_src
  case "$CARCH" in
    x86_64)  bin_src="${srcdir}/omnictl-linux-amd64-v${pkgver}" ;;
    aarch64) bin_src="${srcdir}/omnictl-linux-arm64-v${pkgver}" ;;
    *) echo "Unsupported architecture: $CARCH" >&2; return 1 ;;
  esac

  install -Dm755 "${bin_src}" "${pkgdir}/usr/bin/omnictl"

  # Shell completions generated from the installed binary, mirroring talosctl-bin
  "${pkgdir}/usr/bin/omnictl" completion bash | install -Dm644 /dev/stdin \
    "${pkgdir}/usr/share/bash-completion/completions/omnictl"
  "${pkgdir}/usr/bin/omnictl" completion zsh | install -Dm644 /dev/stdin \
    "${pkgdir}/usr/share/zsh/site-functions/_omnictl"
  "${pkgdir}/usr/bin/omnictl" completion fish | install -Dm644 /dev/stdin \
    "${pkgdir}/usr/share/fish/vendor_completions.d/omnictl.fish"
}
