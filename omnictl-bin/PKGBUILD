# Maintainer: Okiki <okiki@thunderstrike.co>
pkgname=omnictl-bin
pkgver='1.4.6'
pkgrel=1
pkgdesc="CLI for Omni - SaaS-simple deployment of Kubernetes on your own hardware"
arch=('x86_64' 'aarch64')
url="https://omni.siderolabs.com/"
license=('BUSL-1.1')

# Arch-per-arch sources (prebuilt upstream binaries)
source_x86_64=(
  "omnictl-linux-amd64-v${pkgver}::https://github.com/siderolabs/omni/releases/download/v${pkgver}/omnictl-linux-amd64"
)
source_aarch64=(
  "omnictl-linux-arm64-v${pkgver}::https://github.com/siderolabs/omni/releases/download/v${pkgver}/omnictl-linux-arm64"
)

sha256sums_x86_64=('047bf227ffce8496a2e34060941e90736f16d83be71868f973317ee7fddc6e59')
sha256sums_aarch64=('6a8629e6b5eec361d45cfcb5109d621bb61c5e4a548643e99a10f07693fab8ad')

# Don't strip the prebuilt binary
options=(!strip)

# Optional: no build() because this is a binary package

check() {
  local bin_src
  case "$CARCH" in
    x86_64)  bin_src="${srcdir}/omnictl-linux-amd64-v${pkgver}" ;;
    aarch64) bin_src="${srcdir}/omnictl-linux-arm64-v${pkgver}" ;;
    *) echo "Unsupported architecture: $CARCH" >&2; return 1 ;;
  esac

  # Ensure the downloaded binary is executable
  chmod +x "${bin_src}"

  # Sanity check: binary runs and prints help
  "${bin_src}" --help >/dev/null
}

package() {
  local bin_src
  case "$CARCH" in
    x86_64)  bin_src="${srcdir}/omnictl-linux-amd64-v${pkgver}" ;;
    aarch64) bin_src="${srcdir}/omnictl-linux-arm64-v${pkgver}" ;;
    *) echo "Unsupported architecture: $CARCH" >&2; return 1 ;;
  esac

  install -Dm755 "${bin_src}" "${pkgdir}/usr/bin/omnictl"

  # Generate and install shell completions
  install -dm755 "${pkgdir}/usr/share/bash-completion/completions"
  install -dm755 "${pkgdir}/usr/share/zsh/site-functions"
  install -dm755 "${pkgdir}/usr/share/fish/vendor_completions.d"

  # Shell completions
  "${pkgdir}/usr/bin/omnictl" completion bash | install -Dm644 /dev/stdin \
    "${pkgdir}/usr/share/bash-completion/completions/omnictl"
  "${pkgdir}/usr/bin/omnictl" completion zsh | install -Dm644 /dev/stdin \
    "${pkgdir}/usr/share/zsh/site-functions/_omnictl"
  "${pkgdir}/usr/bin/omnictl" completion fish | install -Dm644 /dev/stdin \
    "${pkgdir}/usr/share/fish/vendor_completions.d/omnictl.fish"
}
