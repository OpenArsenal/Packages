# Maintainer: Okiki <okiki@thunderstrike.co>

pkgname=lmstudio-bin
_appname=lm-studio

# Version format: X.Y.Z.B where B is the build number
# Example: 0.3.39.2 means version 0.3.39, build 2
pkgver=0.3.39.2

# Transform pkgver for installer URL: 0.3.39.2 â†’ 0.3.39-2
_version="${pkgver%.*}"           # Extract version (0.3.39)
_build="${pkgver##*.}"            # Extract build (2)
_pkgver="${_version}-${_build}"   # Construct URL format (0.3.39-2)

pkgrel=1
pkgdesc="Discover, download, and run local LLMs"
arch=('x86_64')
url="https://lmstudio.ai/"
license=('LicenseRef-EULA')
depends=('zlib' 'hicolor-icon-theme' 'fuse2' 'clblast')
makedepends=('squashfs-tools' 'graphicsmagick')
options=(!strip !debug)

_appimage="${pkgname}-${pkgver}.AppImage"

# Installer URL uses hyphen format: 0.3.39-2
source=("${_appimage}::https://installers.lmstudio.ai/linux/x64/${_pkgver}/LM-Studio-${_pkgver}-x64.AppImage")
sha256sums=('SKIP')  # Use 'SKIP' or run updpkgsums after first download
noextract=("${_appimage}")

prepare() {
    rm -rf squashfs-root
    chmod +x "${_appimage}"
    
    # Extract files needed for packaging
    offset=$(./"${_appimage}" --appimage-offset)
    unset PAGER  # unsquashfs is sensitive to PAGER settings
    
    unsquashfs -q -o "$offset" -d squashfs-root "${_appimage}" \
        "${_appname}.desktop" \
        "usr/share/icons/hicolor/0x0/apps/lm-studio.png" \
        "LICENSE.electron.txt" \
        "LICENSES.chromium.html"
}

build() {
    # Adjust .desktop file for system installation
    sed -i -E "s|Exec=AppRun|Exec=env DESKTOPINTEGRATION=false /usr/bin/${pkgname%-bin}|" \
        "squashfs-root/${_appname}.desktop"
    sed -i -E "s|Icon=.*|Icon=${pkgname%-bin}|" \
        "squashfs-root/${_appname}.desktop"
}

package() {
    # Install AppImage
    install -Dm755 "${srcdir}/${_appimage}" \
        "${pkgdir}/opt/${pkgname}/${_appname}.AppImage"
    
    # Install licenses
    install -Dm644 "${srcdir}/squashfs-root/LICENSE"* \
        -t "${pkgdir}/usr/share/licenses/${pkgname}"
    install -Dm644 /dev/stdin "$pkgdir/usr/share/licenses/$pkgname/EULA" \
        <<< "https://lmstudio.ai/app-terms"
    
    # Install desktop file
    install -Dm644 "${srcdir}/squashfs-root/${_appname}.desktop" \
        "${pkgdir}/usr/share/applications/${pkgname%-bin}.desktop"
    
    # Generate and install icons at multiple sizes
    local src_icon="$srcdir/squashfs-root/usr/share/icons/hicolor/0x0/apps/lm-studio.png"
    local sizes=("16x16" "32x32" "48x48" "64x64" "128x128" "256x256")
    
    for size in "${sizes[@]}"; do
        install -dm755 "${pkgdir}/usr/share/icons/hicolor/$size/apps"
        gm convert "$src_icon" -resize "$size" \
            "$pkgdir/usr/share/icons/hicolor/$size/apps/${pkgname%-bin}.png"
    done
    
    # Create symlink for command-line execution
    install -dm755 "${pkgdir}/usr/bin"
    ln -s "/opt/${pkgname}/${_appname}.AppImage" \
        "${pkgdir}/usr/bin/${pkgname%-bin}"
}

# vim:set ts=2 sw=2 et:
