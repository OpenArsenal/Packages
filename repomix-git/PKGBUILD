# Maintainer: <you>

pkgname=repomix-git
pkgver=1.11.1.r91.gedaeff6
pkgrel=1
pkgdesc="Pack a repository into a single AI-friendly file (CLI) (git)"
arch=('any')
url="https://repomix.com/"
license=('MIT')

depends=('nodejs>=20')
makedepends=('git' 'npm')
optdepends=('git: pack remote repositories')
provides=('repomix')
conflicts=('repomix')

source=("git+https://github.com/yamadashy/repomix.git")
sha256sums=('SKIP')

pkgver() {
  cd "${srcdir}/repomix"
  git describe --long --tags --abbrev=7 | sed 's/^v//; s/-/.r/; s/-/./'
}

build() {
  cd "${srcdir}/repomix"

  export npm_config_cache="${srcdir}/npm-cache"
  export npm_config_update_notifier=false
  export npm_config_fund=false
  export npm_config_audit=false
  export npm_config_progress=false

  npm ci
  npm run build
}

package() {
  cd "${srcdir}/repomix"

  npm install -g \
    --prefix "${pkgdir}/usr" \
    --omit=dev \
    "${srcdir}/repomix"

  install -Dm644 \
    "${pkgdir}/usr/lib/node_modules/repomix/LICENSE" \
    "${pkgdir}/usr/share/licenses/repomix/LICENSE"

  find "${pkgdir}/usr/lib/node_modules/repomix" -perm -0022 -exec chmod go-w {} +
}
