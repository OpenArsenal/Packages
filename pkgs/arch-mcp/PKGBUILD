# Maintainer: Carl <you@example.com>

pkgname=arch-mcp
pkgver=3.3.6
pkgrel=1
pkgdesc="MCP server bridging AI assistants with Arch Linux ecosystem (Wiki, AUR, official repos)"
arch=('any')
url="https://github.com/nihalxkumar/arch-mcp"
license=('GPL-3.0-only' 'MIT')

depends=(
  'python'
  'python-beautifulsoup4'
  'python-httpx'
  'python-lxml'
  'python-markdownify'

  # MCP Python SDK (AUR)
  'python-mcp'
)

# Optional: HTTP/SSE server entrypoint (arch-ops-server-http) needs these at runtime.
# Keep them optional so the base (stdio) server stays lean.
optdepends=(
  'python-starlette: enable HTTP/SSE transport (arch-ops-server-http)'
  'uvicorn: run HTTP/SSE transport server (arch-ops-server-http)'
)

makedepends=(
  'python-build'
  'python-installer'
  'python-wheel'

  # REQUIRED because upstream uses the uv PEP517 build backend: `uv_build`
  # and we build with --no-isolation.
  'python-uv-build'
)

checkdepends=(
  'python-pytest'
  'python-pytest-asyncio'
)

source=(
  "${pkgname}-${pkgver}.tar.gz::https://github.com/nihalxkumar/arch-mcp/archive/refs/tags/v${pkgver}.tar.gz"
)
sha256sums=('787fa93d6d1b3ac643fbd06e969b3e8b1c15472191fada58e650706d97a86b83')

_dir="arch-mcp-${pkgver}"

prepare() {
  cd "${_dir}"

  # Upstream pins uv_build <0.10.0, but Arch/CachyOS ships 0.10.x.
  # Astral's release notes say there are no breaking changes to uv_build and
  # explicitly recommend bumping the upper bound (e.g. <0.10.0 -> <0.11.0).
  # This keeps builds deterministic (no PEP517 isolated env downloads).
  sed -i -E \
    -e 's/uv_build<0\.10\.0,>=0\.9\.4/uv_build<0.11.0,>=0.9.4/g' \
    -e 's/uv_build>=0\.9\.4,<0\.10\.0/uv_build>=0.9.4,<0.11.0/g' \
    pyproject.toml
}

build() {
  cd "${_dir}"
  python -m build --wheel --no-isolation
}

package() {
  cd "${_dir}"

  python -m installer --destdir="${pkgdir}" dist/*.whl

  # Docs
  install -Dm644 README.md -t "${pkgdir}/usr/share/doc/${pkgname}"

  # Licenses: upstream is dual-licensed and ships these exact filenames.
  install -Dm644 LICENSE-GPL "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE-GPL"
  install -Dm644 LICENSE-MIT "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE-MIT"
}
