# Maintainer: Okiki Ojo <okiki@thunderstrike.co>

pkgname=calibre-bin
pkgver='9.2.1'
pkgrel=1
pkgdesc="Official binary version Calibre"
arch=(x86_64 aarch64)
url="https://download.calibre-ebook.com"
license=(GPL3)
depends=()
makedepends=()
optdepends=()
conflicts=(calibre calibre-git)
provides=(calibre)
options=('!strip')
replaces=("${pkgname%-bin}")

# Sources
#   Since there doesn't seem to be a simple way to generate desktop
#   integration files without building calibre from source,
#   we'll provide them here
source=(share.tar.xz)

# Arch-per-arch sources (prebuilt upstream binaries)
source_x86_64=("calibre-${pkgver}-x86_64.txz::https://github.com/kovidgoyal/calibre/releases/download/v${pkgver}/calibre-${pkgver}-x86_64.txz")
source_aarch64=("calibre-${pkgver}-aarch64.txz::https://github.com/kovidgoyal/calibre/releases/download/v${pkgver}/calibre-${pkgver}-arm64.txz")

# Checksums
sha256sums=('c7aae61afba19c9cceed8bbafd2b39b5c4d6d683de0ccfc9c1fe2651857f757a')
sha256sums_x86_64=('b1e44b06ff90a3ebaad784a0178343bb34a58e4745091a3165aa26206c674755')
sha256sums_aarch64=('e41e25397086170d9c6c2ccfa3f3117049e9d5b0d448542bf00669a8466337fb')

package() {
  install -dm755 "$pkgdir/usr/bin" "$pkgdir/opt/calibre"


  # Find the first top-level directory that looks like the calibre payload.
  # (Adjust this heuristic once you confirm the extracted layout.)
  local payload_dir
  payload_dir="$(find "$srcdir" -maxdepth 1 -type d -name 'calibre*' -print -quit)"

  if [[ -z "$payload_dir" ]]; then
    echo "ERROR: Could not find extracted calibre payload directory in \$srcdir" >&2
    return 1
  fi

  # Copy only what you actually intend (adjust if the extracted directory name differs)
  # Example assumes the txz extracts directly into $srcdir with calibre binaries at the top-level.
  cp -aT "$payload_dir" "$pkgdir/opt/calibre"

  # If your share.tar.xz provides /share, move it under /usr
  if [[ -d "$pkgdir/opt/calibre/share" ]]; then
    mv -f "$pkgdir/opt/calibre/share" "$pkgdir/usr/"
  fi

  # Symlink top-level executables from /opt/calibre into /usr/bin
  find "$pkgdir/opt/calibre" -maxdepth 1 -type f -printf '%f\0' |
    while IFS= read -r -d '' f; do
      ln -s "/opt/calibre/$f" "$pkgdir/usr/bin/$f"
    done
}
