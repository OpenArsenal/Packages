# Maintainer: Okiki Ojo <okiki@thunderstrike.co>

pkgname=calibre-bin
pkgver='9.2.1'
pkgrel=1
pkgdesc="Official binary version Calibre"
arch=(x86_64 aarch64)
url="https://download.calibre-ebook.com"
license=(GPL3)
depends=()
makedepends=()
optdepends=()
conflicts=(calibre calibre-git)
provides=(calibre)
options=('!strip')
replaces=("${pkgname%-bin}")

# Kovid Goyal's GPG key for signature verification
validpgpkeys=('3CE1780F78DD88DF45194FD706BC317B515ACE7C')  # Kovid Goyal <kovid@kovidgoyal.net>

# Sources
#   Since there doesn't seem to be a simple way to generate desktop
#   integration files without building calibre from source,
#   we'll provide them here
source=(share.tar.xz)

# Arch-per-arch sources (prebuilt upstream binaries from calibre.com with GPG signatures)
source_x86_64=(
  "calibre-${pkgver}-x86_64.txz::https://download.calibre-ebook.com/${pkgver}/calibre-${pkgver}-x86_64.txz"
  "calibre-${pkgver}-x86_64.txz.sig::https://calibre-ebook.com/signatures/calibre-${pkgver}-x86_64.txz.sig"
)
source_aarch64=(
  "calibre-${pkgver}-aarch64.txz::https://download.calibre-ebook.com/${pkgver}/calibre-${pkgver}-arm64.txz"
  "calibre-${pkgver}-aarch64.txz.sig::https://calibre-ebook.com/signatures/calibre-${pkgver}-arm64.txz.sig"
)

# Checksums (using SHA-512 as provided by calibre)
sha512sums=('f998af4d431d95149528691daf7d43c75052e6586c54b4d5595a6a8886d7d0b97ff355a1e25b64e6a606b679b096c49d6048a82ff1061611ad87ed0bb587e147'
            'ca081a89522c0d719f0fe8209735a23fc778d870681c4d1cbcb6654fa685e36f1ced6640284ba6608570dce88289d3f5ea35cdc19b902abfcc8c3d9e0a2e2148')
sha512sums_x86_64=('5148aceed1b051a08aa2088ac655d50e79471d64ff6b9bc247947afde3e2c37f019334d71baf20ab692db25420372802d51930afb1f8be547265f9aca8eb76bb'
                   'SKIP')
sha512sums_aarch64=('f9b362b63a355a7ddc4b170c2d3850e7b1e0f504ca352268d0514be2f990605a55549e7e236fbbce2a84c998ae0a97c4302fd7c4b3876c8449e76d05e609c7f0'
                    'SKIP')

package() {
  install -dm755 "$pkgdir/usr/bin" "$pkgdir/opt/calibre"


  # Find the first top-level directory that looks like the calibre payload.
  # (Adjust this heuristic once you confirm the extracted layout.)
  local payload_dir
  payload_dir="$(find "$srcdir" -maxdepth 1 -type d -name 'calibre*' -print -quit)"

  if [[ -z "$payload_dir" ]]; then
    echo "ERROR: Could not find extracted calibre payload directory in \$srcdir" >&2
    return 1
  fi

  # Copy only what you actually intend (adjust if the extracted directory name differs)
  # Example assumes the txz extracts directly into $srcdir with calibre binaries at the top-level.
  cp -aT "$payload_dir" "$pkgdir/opt/calibre"

  # If your share.tar.xz provides /share, move it under /usr
  if [[ -d "$pkgdir/opt/calibre/share" ]]; then
    mv -f "$pkgdir/opt/calibre/share" "$pkgdir/usr/"
  fi

  # Symlink top-level executables from /opt/calibre into /usr/bin
  find "$pkgdir/opt/calibre" -maxdepth 1 -type f -printf '%f\0' |
    while IFS= read -r -d '' f; do
      ln -s "/opt/calibre/$f" "$pkgdir/usr/bin/$f"
    done
}
