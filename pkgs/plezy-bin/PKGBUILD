# Maintainer: Okiki <okiki@thunderstrike.co>

pkgname=plezy-bin
_pkgname=plezy
pkgver='1.16.1'
pkgrel=1
pkgdesc="Modern Plex client built with Flutter (prebuilt binary)"
arch=('x86_64')
url="https://github.com/edde746/plezy"
license=('GPL-3.0-or-later')

depends=(
  'gtk3'
  'glib2'
  'libepoxy'
  'libkeybinder3'
  'alsa-lib'
  'mpv'
)

provides=("$_pkgname")
conflicts=("$_pkgname" "${_pkgname}-git")
replaces=("${pkgname%-bin}")

# Prebuilt binaries are often already stripped and may contain weird sections.
options=(!strip)

source=(
  "$pkgname-$pkgver.tar.gz::https://github.com/edde746/plezy/releases/download/${pkgver}/plezy-linux.tar.gz"
  # Pull license from upstream tag so /usr/share/licenses is correct.
  "LICENSE-$pkgver::https://raw.githubusercontent.com/edde746/plezy/${pkgver}/LICENSE"
)

sha256sums=('7004ac457469ffe9c4db33742f815042cf21e8c9b8ef400143a091d4a7d88ba7'
            '3972dc9744f6499f0f9b2dbf76696f2ae7ad8af9b23dde66d6af86c9dfb36986')

package() {
  cd "$srcdir"

  install -dm755 "$pkgdir/opt/$_pkgname"
  cp -a data lib plezy "$pkgdir/opt/$_pkgname/"

  # Wrapper: fixes CWD-dependent Flutter bundle behavior.
  install -Dm755 /dev/stdin "$pkgdir/usr/bin/$_pkgname" <<'EOF'
#!/usr/bin/env bash
cd /opt/plezy
exec ./plezy "$@"
EOF

  # Desktop entry (generate it so Exec/Icon are guaranteed correct)
  install -Dm644 /dev/stdin "$pkgdir/usr/share/applications/com.edde746.plezy.desktop" <<'EOF'
[Desktop Entry]
Type=Application
Name=Plezy
Comment=Modern Plex media client
Exec=plezy %U
Icon=plezy
Terminal=false
Categories=AudioVideo;Video;Player;
StartupWMClass=plezy
EOF

  # Icon: install one canonical size (donâ€™t lie about multiple sizes).
  install -Dm644 "data/flutter_assets/assets/plezy.png" \
    "$pkgdir/usr/share/icons/hicolor/512x512/apps/plezy.png"

  install -Dm644 "LICENSE-$pkgver" "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}
