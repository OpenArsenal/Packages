# Maintainer: <you>

pkgname=repomix
pkgver=1.11.1
pkgrel=1
pkgdesc="Pack a repository into a single AI-friendly file (CLI)"
arch=('any')
url="https://repomix.com/"
license=('MIT')

depends=('nodejs>=20')
makedepends=('npm' 'jq')
optdepends=('git: pack remote repositories')
conflicts=('repomix-git')

source=("${pkgname}-${pkgver}.tgz::https://registry.npmjs.org/${pkgname}/-/${pkgname}-${pkgver}.tgz")
sha256sums=('011c9a566f3373288d2139078e3713cc0bcda1cff33fa704949f085a83cb16d5')

package() {
  cd "${srcdir}"

  export npm_config_cache="${srcdir}/npm-cache"
  export npm_config_update_notifier=false
  export npm_config_fund=false
  export npm_config_audit=false
  export npm_config_progress=false

  npm install -g \
    --prefix "${pkgdir}/usr" \
    --omit=dev \
    "${srcdir}/${pkgname}-${pkgver}.tgz"

  install -Dm644 \
    "${pkgdir}/usr/lib/node_modules/${pkgname}/LICENSE" \
    "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"

  # Main package: remove underscore-prefixed keys in package.json (e.g. _from, _resolved, _where)
  pkgjson="$pkgdir/usr/lib/node_modules/$pkgname/package.json"
  tmpjson="$(mktemp -p "$srcdir" "${pkgname}.pkgjson.XXXXXX")"
  jq '.|=with_entries(select(.key|test("^_.+")|not))' "$pkgjson" > "$tmpjson"
  install -m644 "$tmpjson" "$pkgjson"
  rm -f "$tmpjson"

  # Fix only "too permissive" perms without making random files executable:
  # remove group/other write bits wherever they appear.
  find "${pkgdir}/usr/lib/node_modules/${pkgname}" -perm -0022 -exec chmod go-w {} +
}
