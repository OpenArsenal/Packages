# Maintainer: <you>
pkgname=container-use-bin
_pkgname=container-use
pkgver=0.4.2
pkgrel=1
pkgdesc="Sandboxed dev environments for coding agents (Dagger-powered), with git worktree workflows"
arch=('x86_64' 'aarch64')
url="https://container-use.com"
license=('Apache-2.0')

depends=('glibc')
optdepends=(
  'git: enable Git-based Container Use workflows'
  'docker: container runtime for environments'
  'podman: alternative container runtime'
)

provides=("${_pkgname}")
conflicts=("${_pkgname}" "${_pkgname}-git")

# Release assets (prebuilt binaries) + checksums.txt
source=(
  "${_pkgname}_v${pkgver}_checksums.txt::https://github.com/dagger/${_pkgname}/releases/download/v${pkgver}/checksums.txt"
)
source_x86_64+=(
  "${_pkgname}_v${pkgver}_linux_amd64.tar.gz::https://github.com/dagger/${_pkgname}/releases/download/v${pkgver}/${_pkgname}_v${pkgver}_linux_amd64.tar.gz"
)
source_aarch64+=(
  "${_pkgname}_v${pkgver}_linux_arm64.tar.gz::https://github.com/dagger/${_pkgname}/releases/download/v${pkgver}/${_pkgname}_v${pkgver}_linux_arm64.tar.gz"
)

sha256sums=('284db6dd42aed005333af0a1a33b5b7266cb6dae607f23acdb5203ba099e3a43')
sha256sums_x86_64=('3fa52b5833ae4aed2be4b86f7cf42671fdf4bca8c211fe5fff08cc19553d409b')
sha256sums_aarch64=('96db6bc01111c573df83065bd02802a36a09864f45373169ffa227a9b3cdca14')

prepare() {
  cd "${srcdir}"

  local _tar=""
  case "${CARCH}" in
    x86_64)  _tar="${_pkgname}_v${pkgver}_linux_amd64.tar.gz" ;;
    aarch64) _tar="${_pkgname}_v${pkgver}_linux_arm64.tar.gz" ;;
    *) echo "Unsupported arch: ${CARCH}" >&2; return 1 ;;
  esac

  # Verify ONLY the tarball we actually downloaded.
  grep -F "${_tar}" "${_pkgname}_v${pkgver}_checksums.txt" | sha256sum -c -
}

package() {
  cd "${srcdir}"

  local _tar=""
  case "${CARCH}" in
    x86_64)  _tar="${_pkgname}_v${pkgver}_linux_amd64.tar.gz" ;;
    aarch64) _tar="${_pkgname}_v${pkgver}_linux_arm64.tar.gz" ;;
    *) echo "Unsupported arch: $CARCH" >&2; exit 1 ;;
  esac

  mkdir -p "${pkgname}"
  bsdtar -xf "${_tar}" -C "${pkgname}"

  # The archive layout can vary (goreleaser often nests). Find an executable we can install.
  local _bin=""
  _bin="$(find "${pkgname}" -maxdepth 3 -type f -perm -111 -name "${_pkgname}" -print -quit)"
  if [[ -z "${_bin}" ]]; then
    _bin="$(find "${pkgname}" -maxdepth 3 -type f -perm -111 -name "cu" -print -quit)"
  fi

  if [[ -z "${_bin}" ]]; then
    printf 'ERROR: could not find %s or cu executable in release archive\n' "${_pkgname}" >&2
    return 1
  fi

  install -Dm755 "${_bin}" "${pkgdir}/usr/bin/${_pkgname}"

  # Friendly alias: /usr/bin/cu -> container-use
  ln -s "${_pkgname}" "${pkgdir}/usr/bin/cu"

  # Install license if it exists in the archive (common with goreleaser)
  local _license=""
  _license="$(find "${pkgname}" -maxdepth 3 -type f -iname 'LICENSE*' -print -quit)"
  if [[ -n "${_license}" ]]; then
    install -Dm644 "${_license}" "${pkgdir}/usr/share/licenses/${_pkgname}/LICENSE"
  fi

  # Install docs if it exists in the archive (common with goreleaser)
  local _docs=""
  _docs="$(find "${pkgname}" -maxdepth 3 -type f -iname 'README*' -print -quit)"
  if [[ -n "${_docs}" ]]; then
    install -Dm644 "${_docs}" -t "${pkgdir}/usr/share/doc/${_pkgname}/"
  fi

  # Install manpage if it exists in the archive (common with goreleaser)
  local _manpage=""
  _manpage="$(find "${pkgname}/man" -maxdepth 3 -type f -iname "${_pkgname}.1*" -print -quit)"
  if [[ -n "${_manpage}" ]]; then
    install -Dm644 "${_manpage}" -t "${pkgdir}/usr/share/man/man1/"
  fi
  
  # Install shell completions if they exist in the archive
  local _completions_dir="${pkgname}/completions"
  if [[ -d "${_completions_dir}" ]]; then
    local _file _basename _name _ext

    for _file in "${_completions_dir}"/*; do
      [[ -f "${_file}" ]] || continue
      _basename="$(basename "${_file}")"
      _name="${_basename%.*}"
      _ext="${_basename##*.}"

      case "${_ext}" in
        bash)
          install -Dm644 "${_file}" "${pkgdir}/usr/share/bash-completion/completions/${_name}"
          ;;
        fish)
          install -Dm644 "${_file}" "${pkgdir}/usr/share/fish/vendor_completions.d/${_basename}"
          ;;
        zsh)
          install -Dm644 "${_file}" "${pkgdir}/usr/share/zsh/site-functions/_${_name}"
          ;;
        *)
          msg2 "Skipping unknown completion file: ${_basename}"
          ;;
      esac
    done
  fi

}
