# Maintainer: Okiki <okiki@thunderstrike.co>
pkgname=omnictl-bin
pkgver='1.5.0'
pkgrel=1
pkgdesc="CLI for Omni - SaaS-simple deployment of Kubernetes on your own hardware"
arch=('x86_64' 'aarch64')
url="https://omni.siderolabs.com/"
license=('BUSL-1.1')
replaces=("${pkgname%-bin}")

# Arch-per-arch sources (prebuilt upstream binaries)
source_x86_64=(
  "omnictl-linux-amd64-v${pkgver}::https://github.com/siderolabs/omni/releases/download/v${pkgver}/omnictl-linux-amd64"
)
source_aarch64=(
  "omnictl-linux-arm64-v${pkgver}::https://github.com/siderolabs/omni/releases/download/v${pkgver}/omnictl-linux-arm64"
)

sha256sums_x86_64=('66050e46f31d8158c5a5faba57df2f478c69ff0316218005381c8c611b1ca8f7')
sha256sums_aarch64=('5141723795e0f69b5d60b7d7c5615a27287ee07d5a8954896f90d598283e8578')

# Don't strip the prebuilt binary
options=(!strip)

# Optional: no build() because this is a binary package

check() {
  local bin_src
  case "$CARCH" in
    x86_64)  bin_src="${srcdir}/omnictl-linux-amd64-v${pkgver}" ;;
    aarch64) bin_src="${srcdir}/omnictl-linux-arm64-v${pkgver}" ;;
    *) echo "Unsupported architecture: $CARCH" >&2; return 1 ;;
  esac

  # Ensure the downloaded binary is executable
  chmod +x "${bin_src}"

  # Sanity check: binary runs and prints help
  "${bin_src}" --help >/dev/null
}

package() {
  local bin_src
  case "$CARCH" in
    x86_64)  bin_src="${srcdir}/omnictl-linux-amd64-v${pkgver}" ;;
    aarch64) bin_src="${srcdir}/omnictl-linux-arm64-v${pkgver}" ;;
    *) echo "Unsupported architecture: $CARCH" >&2; return 1 ;;
  esac

  install -Dm755 "${bin_src}" "${pkgdir}/usr/bin/omnictl"

  # Generate and install shell completions
  install -dm755 "${pkgdir}/usr/share/bash-completion/completions"
  install -dm755 "${pkgdir}/usr/share/zsh/site-functions"
  install -dm755 "${pkgdir}/usr/share/fish/vendor_completions.d"

  # Shell completions
  "${pkgdir}/usr/bin/omnictl" completion bash | install -Dm644 /dev/stdin \
    "${pkgdir}/usr/share/bash-completion/completions/omnictl"
  "${pkgdir}/usr/bin/omnictl" completion zsh | install -Dm644 /dev/stdin \
    "${pkgdir}/usr/share/zsh/site-functions/_omnictl"
  "${pkgdir}/usr/bin/omnictl" completion fish | install -Dm644 /dev/stdin \
    "${pkgdir}/usr/share/fish/vendor_completions.d/omnictl.fish"
}
