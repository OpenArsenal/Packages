# Maintainer: Okiki Ojo <okiki@thunderstrike.co>
_pkgname=figma-linux
pkgname=${_pkgname}
pkgver=0.11.5
pkgrel=1
pkgdesc="Unofficial Electron-based Figma desktop client for Linux (bundled Electron)"
arch=('x86_64' 'aarch64')
url="https://github.com/Figma-Linux/figma-linux"
license=('GPL-2.0-only')

provides=('figma-linux')
conflicts=('figma-linux' 'figma-linux-electron' 'figma-linux-electron-git')

options=(!strip)
depends=('gtk3' 'nss' 'alsa-lib' 'hicolor-icon-theme')
makedepends=('nodejs' 'npm')
optdepends=(
	'xdg-utils: Open links and files'
	'libnotify: Desktop notifications'
)

source=(
	"${_pkgname}-${pkgver}.tar.gz::${url}/archive/refs/tags/v${pkgver}.tar.gz"
	"figma-linux.desktop"
	"figma-linux.sh"
)

# Run updpkgsums after creating the files
sha256sums=('015c6340d6bfdc70901863afb858c8d3da09356e035d5d7a0741131cfef410c6'
            '5029d26b935d5527c9a71f1a3fe81264f92a3d4a9f1c3b71296623d8d9d1edb2'
            '8107c539597b6cb1c38656353956cdad5e8cbdbfd31ace1bb5804c05db8ae4c5')

_configure_npm_mirrors() {
	# This function is intentionally "opt-in".
	# If the builder doesn't set any env vars, it does nothing.
	#
	# Supported env vars:
	# - NPM_CONFIG_REGISTRY
	# - ELECTRON_MIRROR
	# - ELECTRON_BUILDER_BINARIES_MIRROR
	#
	# These mirror vars are respected by npm and/or electron-builder tooling.
	# We also write them into .npmrc for visibility and consistency.

	if [[ -n "${NPM_CONFIG_REGISTRY:-}" ]]; then
		printf 'registry=%s\n' "${NPM_CONFIG_REGISTRY}" >> .npmrc
	fi

	if [[ -n "${ELECTRON_MIRROR:-}" ]]; then
		printf 'electron_mirror=%s\n' "${ELECTRON_MIRROR}" >> .npmrc
	fi

	if [[ -n "${ELECTRON_BUILDER_BINARIES_MIRROR:-}" ]]; then
		printf 'electron_builder_binaries_mirror=%s\n' "${ELECTRON_BUILDER_BINARIES_MIRROR}" >> .npmrc
	fi
}

build() {
	cd "${srcdir}/${_pkgname}-${pkgver}"

	export HOME="${srcdir}/.home"
	export npm_config_cache="${srcdir}/.npm-cache"

	# Recreate .npmrc every build so you don't accumulate duplicated lines
	: > .npmrc
	printf 'cache=%s\n' "${npm_config_cache}" >> .npmrc

	# ðŸ‘‡ Apply opt-in mirrors (only if env vars exist)
	_configure_npm_mirrors

	# Use lockfile if available for reproducible builds
	if [[ -f package-lock.json ]]; then
		npm ci --no-audit --no-fund
	else
		npm install --no-audit --no-fund
	fi

	# Build application
	npm run build
	
	# Create Linux bundle with electron-builder
	npm exec -c "electron-builder --linux dir --config=config/builder.json"
}

package() {
	cd "${srcdir}/${_pkgname}-${pkgver}"

	# Find electron-builder output directory
	local _out=""
	_out="$(find . -maxdepth 3 -type d -name 'linux-*unpacked' 2>/dev/null | head -n 1 || true)"

	if [[ -z "${_out}" || ! -d "${_out}" ]]; then
		echo "ERROR: Could not find linux-*unpacked output directory" >&2
		exit 1
	fi

	# Install entire bundled application (includes electron runtime)
	install -d "${pkgdir}/usr/lib/${_pkgname}"
	cp -a "${_out}/." "${pkgdir}/usr/lib/${_pkgname}/"

	# Create predictable executable name if needed
	if [[ -x "${pkgdir}/usr/lib/${_pkgname}/${_pkgname}" && ! -e "${pkgdir}/usr/lib/${_pkgname}/${_pkgname}" ]]; then
		ln -s "${_pkgname}" "${pkgdir}/usr/lib/${_pkgname}/${_pkgname}"
	fi
  
	# Install wrapper, desktop entry, license
  install -Dm755 "${srcdir}/figma-linux.sh" "${pkgdir}/usr/bin/${_pkgname}"
  install -Dm644 "${srcdir}/figma-linux.desktop" "${pkgdir}/usr/share/applications/${_pkgname}.desktop"
	install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${_pkgname}/LICENSE"

	# Install icons from upstream repo (not from our sources)
	local -a _icon_sizes=(24x24 32x32 36x36 48x48 64x64 72x72 96x96 128x128 192x192 256x256 384x384 512x512 scalable)
	
	for _size in "${_icon_sizes[@]}"; do
		for _src in "lib/icons/${_size}."*; do
			[[ -e "${_src}" ]] || continue
			local _ext="${_src##*.}"
			install -Dm644 "${_src}" \
				"${pkgdir}/usr/share/icons/hicolor/${_size}/apps/${_pkgname}.${_ext}"
		done
	done
}
