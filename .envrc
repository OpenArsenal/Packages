ensure_dirs() {
  local d
  for d in "$@"; do
    [ -n "${d:-}" ] || continue

    # Safety: refuse to create absolute root-level dirs if something went wrong
    case "$d" in
      "/"|"/repo"*|"/.gnupg"*|"/pkgs"*|"/.cache"* )
        echo "direnv: error: refusing to create '$d' (root path looks wrong)" >&2
        return 1
      ;;
    esac

    if [ -e "$d" ] && [ ! -d "$d" ]; then
      echo "direnv: error: '$d' exists but is not a directory" >&2
      return 1
    fi

    mkdir -p -- "$d" || {
      echo "direnv: error: failed to create directory '$d'" >&2
      return 1
    }
  done
}

export PKGBUILDS_ROOT="${DIRENV_DIR:-$PWD}"
export BUILD_ROOT="${BUILD_ROOT:-$PKGBUILDS_ROOT}"

export PKG_REPO_ARCH="${CARCH:-$(uname -m)}"

export PKGDEST="$PKGBUILDS_ROOT/repo/$PKG_REPO_ARCH"
export SRCPKGDEST="$PKGBUILDS_ROOT/repo/src"
export PKG_DIR="${PKG_DIR:-$PKGBUILDS_ROOT/pkgs}"

export SRCDEST="$PKGBUILDS_ROOT/.cache/makepkg/src"
export BUILDDIR="$PKGBUILDS_ROOT/.cache/makepkg/build"
export LOGDEST="$PKGBUILDS_ROOT/.cache/makepkg/log"

export REPO_NAME="${REPO_NAME:-custom}"
export REPO_DIR="${REPO_DIR:-$PKGBUILDS_ROOT/repo/$PKG_REPO_ARCH}"
export REPO_DB="$REPO_DIR/$REPO_NAME.db.tar.gz"
export REPO_FILES="$REPO_DIR/$REPO_NAME.files.tar.gz"

export GNUPGHOME="$PKGBUILDS_ROOT/.gnupg"

# Ensure required directories exist (now safe + function exists)
ensure_dirs \
  "$PKGDEST" \
  "$SRCPKGDEST" \
  "$PKG_DIR" \
  "$REPO_DIR" \
  "$SRCDEST" \
  "$BUILDDIR" \
  "$LOGDEST" \
  "$GNUPGHOME"

# Feeds + AUR build root alignment
export FEEDS_JSON="${FEEDS_JSON:-$BUILD_ROOT/feeds.json}"
export AURDEST="${AURDEST:-$BUILD_ROOT}"

# Build configuration
export MAKEPKG_FLAGS="${MAKEPKG_FLAGS:--scf --noconfirm --needed}"

# External tool detection
export HAS_AURUTILS="$(command -v aur >/dev/null 2>&1 && echo true || echo false)"
export HAS_PARU="$(command -v paru >/dev/null 2>&1 && echo true || echo false)"
export HAS_BAT="$(command -v bat >/dev/null 2>&1 && echo true || echo false)"
export HAS_DEVTOOLS="$(command -v arch-nspawn >/dev/null 2>&1 && echo true || echo false)"

export PACKAGER="OpenArsenal Contributors <arch-packaging-team(at)openarsenal(dot)com>"

export SOURCE_DATE_EPOCH="$(
  git -C "$PKGBUILDS_ROOT" log -1 --format=%ct 2>/dev/null \
  || date -u +%s
)"
