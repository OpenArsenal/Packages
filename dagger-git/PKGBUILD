# Maintainer: <you>
pkgname=dagger-git
_pkgname=dagger
pkgver=0.19.10.71.g27ae0f6
pkgrel=1
pkgdesc="An open-source runtime for composable workflows (development version)"
arch=('x86_64' 'aarch64')
url="https://dagger.io"
license=('Apache-2.0')

depends=('glibc')
makedepends=('git' 'go')
options=('!lto' '!debug')
optdepends=(
  'docker: container runtime (recommended)'
  'podman: alternative container runtime'
)

provides=('dagger')
conflicts=('dagger' 'dagger-bin')

source=("git+https://github.com/dagger/dagger.git")
sha256sums=('SKIP')

pkgver() {
  cd "$srcdir/$_pkgname"
  # Prefer upstream semver tags like v0.19.10 (ignore tags like sdk/php/vX.Y.Z).
  local _d
  _d="$(git describe --tags --long --abbrev=7 --match 'v[0-9]*' 2>/dev/null || true)"
  if [[ -n "$_d" ]]; then
    printf '%s\n' "$_d" | sed -E 's/^v//; s/-/./g'
  else
    printf '0.0.0.r%s.g%s\n' "$(git rev-list --count HEAD)" "$(git rev-parse --short=7 HEAD)"
  fi
}


prepare() {
  cd "$srcdir/$_pkgname"

  # create directory for build output
  mkdir -p build

  # download dependencies
  export GOPATH="${srcdir}"
  go mod download
}

build() {
  cd "$srcdir/$_pkgname"

  export CGO_ENABLED=0

  # Keep Go caches inside $srcdir so they don't poison your global cache
  # AND so makepkg cleanup won't fight your home dir.
  export GOPATH="$srcdir/.gopath"
  export GOMODCACHE="$GOPATH/pkg/mod"
  export GOCACHE="$srcdir/.gocache"

  mkdir -p "$GOMODCACHE" "$GOCACHE"

  # -modcacherw prevents the classic "rm: cannot remove ... Permission denied"
  # during makepkg cleanup (Go can otherwise leave module dirs read-only).
  export GOFLAGS="-trimpath -buildvcs=false -mod=readonly -modcacherw"


  # Daggerâ€™s CLI entrypoint is typically under ./cmd/dagger in Go projects.
  go build \
    -buildmode=pie \
    -ldflags="-s -w" \
    -o ".build/dagger" \
    ./cmd/dagger
}

package() {
  install -Dm755 "$srcdir/$_pkgname/.build/dagger" "$pkgdir/usr/bin/dagger"
  
  
  # If Go left anything awkward behind, cleanup stages won't choke
  chmod -R u+rwX "$srcdir/.gopath" "$srcdir/.gocache" 2>/dev/null || true


  cd "$srcdir/$_pkgname"
  install -Dm644 LICENSE* "$pkgdir/usr/share/licenses/$_pkgname/LICENSE" 2>/dev/null || true
  install -Dm644 README* -t "$pkgdir/usr/share/doc/$_pkgname/" 2>/dev/null || true
}
